name: Medical Device Verification & Trend Analysis

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: THE TEST RUNNER (WINDOWS)
  # -----------------------------------------------------------------
  verify:
    name: Verify on Windows 2022
    runs-on: windows-2022
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install Playwright Browsers
      run: |
        cd tests/Dosimetry.Tests
        dotnet build
        pwsh bin/Debug/net8.0-windows/playwright.ps1 install --with-deps

    - name: Execute Verification (Generate TRX)
      continue-on-error: true
      run: dotnet test --configuration Debug --logger "trx;LogFileName=test_results.trx" --results-directory ./TestResults

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: raw-test-results
        path: TestResults/*.trx
        if-no-files-found: error

  # -----------------------------------------------------------------
  # JOB 2: THE REPORTER (LINUX)
  # -----------------------------------------------------------------
  report:
    name: Generate Allure Report
    needs: verify
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Test Results
      uses: actions/download-artifact@v4
      with:
        name: raw-test-results
        path: all-test-results

    - name: Load Test History
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    - name: Build Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: all-test-results
        # We tell it where the OLD history is
        allure_history: gh-pages/history
        # We tell it where to save the NEW report
        allure_report: allure-report
        keep_reports: 20

    - name: Deploy Report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        # FIX IS HERE: We publish the REPORT, not the history folder
        publish_dir: allure-report